<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1250">

<meta name="Author" content="Vaclav Dvorsky">

<meta name="GENERATOR" content="Mozilla/4.75 [en] (X11; U; Linux 2.2.16-22 i686) [Netscape]">

<meta name="KeyWords" content="Linux Samba SMB Primary Domain Controller PDC Windows NT">
<meta name="Description" content="Linux Samba SMB Primary Domain Controller PDC Windows NT">

<title>Jak zkrotit zlobivá okna?</title>
<style type="text/css">

<!--
   BODY, TH, TD, TABLE  { font-family: arial CE, helvetica CE, verdana CE, arial, helvetica,    verdana, sans-serif; }
   -->

</style>
</head>

<body text="#000000" bgcolor="#FFFFFF" link="#990000" vlink="#666666" alink="#FF0000">
<table BORDER=0 CELLSPACING=0 CELLPADDING=0 COLS=1 WIDTH="500" >

<tr>
<td>

<b><i><font size=+3>Jak zkrotit zlobivá okna?</b></i></font>

<font color="#663300">
<font size=-1>

<p align="justify">
Pokud máte poèítaèovou sí postavenou na klientech Windows a server jim dìlá Linux se Sambou, jste na tom stejnì jako já. Jistì by jste rádi více experimentovali s Linuxem, ale problémy s okny Vás neustále ruší. V tomto èlánku si ukáeme, jak si zajistíme klid pro studium Linuxu.
<br>
<br>
Znáte to: Právì ladíte Qmail, plné soustøedìní a v tom zazvoní telefon. Chvilku posloucháte a je Vám jasno; bude to chtít nainstalovat Javu. Take vstanete ze idle, jdete ke stanici, odhlásíte uivatele, pøihlásíte administrátora (mezitím zodpovíte asi 5 jinıch uivatelskıch dotazù), nainstalujete JVM, vyèistíte temp, restartujete, necháte pøihlásit uivatele a vyzkoušíte funkènost. Kdy se vrátíte zpìt k Linuxu, u jen tìko hledáte ztracené soustøedìní. Mezitím zazvoní další telefon a jste v háji.
<br>
<br>
A tak pøemıšlíte, jak by bylo krásné mít Windows pìknì všechny úplnì stejné. Na všech stejné service packy, stejné verze JVM, stejné Internet Explorery atd. Jistì Vás nejdøíve napadne pouít programy na vzdálenou správu (AutoIt, netmeeting, VNC, PC Anywhere, Carbon Copy, Back Orifice), jene to není úplnì ono. Ne všechny jsou distribuovány jako otevøenı software a mají i jiné (napø. bezpeènostní) nevıhody. Chtìlo by to elegantnìjší a jednodušší øešení.
<br>
Tady je jedno z monıch.
<br>
<br>
<b>Zavedení systému automatické správy</b>
<br>
Kdy se podíváte do souboru /etc/samba/smb.conf, najdete tam oddíl netlogon. Je to sdílenı adresáø na serveru, ve kterém hledají Windows login script pro pøihlášení do domény. Jméno scriptu je uvedeno v èásti global (logon script = %U.bat) a je vıhodné je mít pro všechny stanice stejné, tøeba logon script = mount.cmd.
<br>
Tento script probíhá na stranì Windows vdy jako první pøi pøihlašování uivatele do domény a je nutné jej vytvoøit v DOSu nebo ve Windows. To proto, e UN*X a Windows pouívají jiné konce øádkù. Pomocí netlogon scriptu je vıhodné pøipojovat uivatelùm sdílené disky ze serveru. Dá se s ním ale dìlat v podstatì cokoli, co je moné provést na pøíkazové øádce Windows. Má však jedno veliké omezení. Bìí s právy uivatele, kterı se ke stanici pøihlásil. To je šikovné, pokud chceme mìnit nìco v profilu uivatele (nabídku Start, plochu) nebo v registrech v oblasti \HKEY_CURRENT_USER, ovšem nainstalovat novı Internet Explorer pøi dobøe nastavené bezpeènostní politice (netlogon\<a href="http://www.google.com/search?hl=en&as_qdr=all&q=netlogon+windows+config.pol&btnG=Google+Search&lr=lang_cs">NTconfig.pol</a>) se nám pomocí netlogon scriptu pravdìpodobnì  nepodaøí.
<br>
<br>
Potøebujeme tedy podobnı script, kterı probìhne s právy administrátora. Proto si nejprve musíme takového uivatele zaloit. V našem pøíkladu jej pojmenujeme trinity; je to hezkı název a obsahuje v sobì init.

<pre>
useradd -g 100 -s /bin/false -m -k /dev/null -c "start NT" trinity
smbadduser trinity:trinity
usermod -G adm trinity
smbpasswd trinity
</pre>

<p align="justify">
První pøíkaz zaloí uivatele trinity bez shellu, s prázdnım home adresáøem. Druhı pøiøadí trinity mezi uivatele Samby. Tøetí pøidá uivatele trinity do skupiny adm, èím se z nìj stane Windows administrátor a ètvrtım pøíkazem nastavíme trinity heslo. Heslo zvolíme podle nejpøísnìjších pravidel pro hesla, tedy hodnì dlouhé a velmi komplikované. Heslo uivatele trinity by se pozdìji jen velmi tìko mìnilo.
<br>
<br>
Máme tedy uivatele s právy administrátora. Nyní si pøipravíme jednoduchı script, kterı budeme pod tímto uivatelem spouštìt. Pojmenujeme ho napø. start.bat a jeho obsahem mùe bıt prozatím jediná øádka:
<pre>
net time \\server /set /yes
</pre><p align="justify">
Nakonec je potøeba na stanicích Windows zajistit spouštìní scriptu start.bat pøi pøihlášení pod uivatelem trinity. To je asi nejnároènìjší èást, nebo musíme obejít všechny poèítaèe a na kadém nastavit úlohu po spuštìní.
<br>
Na stanici se pøihlásíme jako trinity, Klikneme na Tento poèítaè > Naplánované úlohy > Pøidat naplánovanou úlohu > Procházet okolní poèítaèe > server\netlogon\start.bat > Pøi pøihlášení > jako uivatel trinity. 
<br>
<center>
<img src=".\pruvodce_naplanovanou_ulohou.png" alt="pruvodce naplanovanou ulohou" width="441" height="318"></center>
<p align="justify">
Obejít všechny poèítaèe je nároèné, ale mùe nás tìšit pocit, e to dìláme ji definitivnì naposledy. 
<br>
<br>
Kdy máme toto všechno hotové, spouští se nám pøi pøihlášení stanice do domény script mount.cmd s právy uivatele a po nìm script start.bat s právy administrátora. Systém automatické správy máme zavedenı. V tomto okamiku se nám pouze synchronizuje èas stanice podle serveru. Monosti vyuití tìchto scriptù v praxi jsou však daleko vìtší. Mùeme z nich volat další scripty (vbs, js, bat), kterımi budeme schopni dìlat si se stanicemi Windows témìø vše, co nás napadne. 
<br>
<br>



<b>Pøíklad instalaèního scriptu</b>
<br>
Pro názornı pøíklad si mùeme ukázat instalaci <a href="http://www.sun.com/download/">Java 2 Runtime Environment, SE v1.4.0</a> na všechny stanice Windows v síti. 
<br>
Pøipravíme tzv. tichou instalaci. Na vybraném poèítaèi rozbalíme soubor j2re-1_4_0-win-i.exe. Spustíme setup -r, kterı nám bìhem instalace vygeneruje silent setup file (setup.iss) do sloky Windows. Tento soubor následnì zadáme jako parametr pro instalaci. 
<br>
<br>
A zde je script pro hromadnou instalaci, kterı budeme spouštìt z \netlogon\start.bat
<pre>
set server=Akira
set logdir=\\%server%\install\log\Java
set insdir=\\%server%\install\Win32

if exist %logdir%\%COMPUTERNAME%.SUN_Java.inst.log goto end

  c:
  mkdir c:\temp\Java
  xcopy %insdir%\Java\Disk1 c:\temp\Java /d /f  
  cd \temp\Java\
  setup.exe -s -f1.\setup.iss -f2%logdir%\%COMPUTERNAME%.SUN_Java.inst.log
  %insdir%\shutdown /L /R /T:20 /Y /C "Java 2 SE v1.4.0: Install"
  pause

goto end

:end
</pre>
<p align="justify">
Tento jednoduchı script v prvním kroku zkontroluje, zda-li ji byl nebo nebyl spuštìn. Pokud byl spuštìn, jde rovnou na konec. Pokud ještì nebyl spuštìn, provede kopírování souborù ze serveru na lokální disk a samotnou instalaci (více informací najdete na stránkách <a href="http://support.installshield.com/kb/kbresults.asp?pm=All&txtkeyword=Q105472&sm=all+words&txtarticleid=&gv=1&acat=both&sa=content&days=0&submit.x=24&submit.y=11">InstallShield</a>). 
Bìhem instalace vytvoøí log soubor poadovaného jména, kterı nám slouí mimo jiné ke kontrole (napø. grep -i -r -a ResultCode=- ./log) a k zamezení opakovaného spuštìní scriptu. Následuje vynucenı restart poèítaèe a nezbytná pause, aby script nepokraèoval. Pøi pøíštím spuštìní stejnı script ji v úvodu zjistí pøítomnost log souboru a skokem na end umoní spuštìní dalších pøípadnıch scriptù.
<br>
<br>
<b>Bezpeènost</b>
<br>
Je jasné, e pøi napadení serveru je tento systém zneuitelnı. Pøípadnı útoèník by mohl snadno zmìnit Vaše startovací scripty a nainstalovat do celé sítì prakticky cokoli. Proto je dùleité zajistit patøièná pøístupová práva k pouívanım adresáøùm a souborùm (netlogon a install). Také je správnì na místì otázka, jestli je moné celı systém automatické správy vypnout. 
<br>
Ano, je to moné. Alespoò co se tıèe scriptù spouštìnıch s právy administrátora. Zpùsobù se jistì najde více. Jedním z nich by mohla bıt zmìna UID uivatele trinity. Windows pak trinity nepoznají a scripty neprovedou. Je to relativnì elegantní øešení, nebo jen Vy jako správce znáte skuteèné UID trinity a mùete ho tak pøíštì, a budete potøebovat, znovu nastavit. Ještì by se dala uvést zmìna hesla trinity, zmìna skupiny nebo zrušení uivatele, ale ani jedno z tìchto øešení nepovauji za šastné.
<br>
<br>
<b>Závìr</b>
<br>
Pokud budete tento systém udrovat rozumnì a nebudete neuváenì odmazávat logy, mùete dosáhnout stavu, kdy si novì nainstalovanı poèítaè (napø. po havárii) sám pøi prvním pøihlášení do domény nainstaluje veškerı další potøebnı software a srovná se tak automaticky s ostatními.
<br>
Myslím si, e tento systém je na správu velmi jednoduchı a ušetøí administrátorovi hodnì práce s obíháním poèítaèù. V ušetøeném èase se pak mùeme nerušenì vìnovat tøeba právì Linuxu...
<br>
<br>
Tento systém byl ovìøenı na Sambì 2.0.7 a WinNT 4.0.
<br>
<br>
<b>Pøíloha</b>
<br>
Netlogon scripty
<br>
<br>
<b>Podìkování</b>
<br>
Libor Šmíd a Milan Martinec za inspiraci
<br>
Vladislav Èermák, Aleš Sojka, Libor Šmíd za VBS scripty
<br>
Radio1 za dobrou hudbu k práci
<br>
<a href="http://us1.samba.org/samba/team.html">Tımu programátorù Samby</a> a všem vıvojáøùm Linuxu.
<br>
<br>
<b>Relevantní linky</b>
<br>
<a href="http://hufhendr.spok.cz/linux/PDC_Linux.html">Linux jako PDC</a> pro sí Windows NT

</p>

<br>V Praze dne 12.03.2002
<br>Václav Dvorskı
</font></font></font>
</td>
</tr>
</table>
</body>
</html>

